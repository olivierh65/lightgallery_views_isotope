{#
  Template récursif pour afficher albums + sous-groupes,
  avec Isotope à tous les niveaux pour une mise en page réactive.
#}

{% macro render_group_recursive(group, options, parent_id, settings, level) %}

	{# ---- ITEM DE GROUPE (pour Isotope du parent) ---- #}
	<div
		class="isotope-item group-item level-{{ level }}" data-level="{{ level }}">

		{# ---- TITRE DU GROUPE (si présent) ---- #}
		{% if group.title %}
			<div class="group-title-wrapper level-{{ level }}">
				{% if group.title|striptags|trim|length == 0 %}
					<span class="group-title level-{{ level }} placeholder" aria-hidden="true">
						&nbsp;
					</span>
				{% else %}
					<span class="group-title level-{{ level }}">
						{{ group.title }}
					</span>
				{% endif  %}
			</div>
		{% endif %}

		{# Vérifier s'il y a du contenu #}
		{% set has_albums = group.albums is defined and group.albums|length > 0 %}
		{% set has_subgroups = group.subgroups is defined and group.subgroups|length > 0 %}

		{% if has_albums or has_subgroups %}
			{# ---- CONTENEUR ISOTOPE POUR LES ENFANTS ---- #}
			{% set group_id = 'isotope-container-' ~ random() %}
			<div
				class="isotope-container" id="{{ group_id }}" data-parent="{{ parent_id }}" data-level="{{ level }} ">

				{# ---- ALBUMS DU GROUPE ---- #}
				{% if has_albums %}
					{# Définir des dimensions par défaut #}
					{% set thumb_width = settings.thumbnail_width|default(218) %}
					{% set thumb_height = settings.thumbnail_height|default(218) %}

					{% for album in group.albums %}
						<div class="isotope-item album-item" style="width: {{ thumb_width }}px; height: {{ thumb_height }}px;" data-width="{{ thumb_width }}" data-height="{{ thumb_height }}">
							{# Lien de couverture de l'album #}

							<a href="#" class="album-cover" data-album-id="{{ album.id }}" data-once="lg-album">
								<span class="album-title">{{ album.title }}</span>
								{% if album.image_url %}
									<img src="{{ album.image_url }}" class="album-img" loading="lazy" alt="{{ album.title }}">
								{% endif %}
							</a>

							{# LightGallery container #}
							<div id="{{ album.id }}" class="lightgallery-album" style="display:none;">
								{% for media in album.medias %}
									{% if media.mime_type starts with 'image/' %}
										<a href="{{ media.url }}" class="lightgallery__item" data-sub-html=".lightgallery_caption">
											<img loading="lazy" src="{{ media.thumbnail }}">
											<div class="lightgallery_caption">
												<h4>{{ media.title|default('') }}</h4>
												{% if media.alt %}
													<p>{{ media.alt }}</p>
												{% endif %}
												{% if media.description %}
													<p>{{ media.description }}</p>
												{% endif %}
											</div>
										</a>
									{% elseif media.mime_type starts with 'video/' %}
										<a class="lightgallery__item" data-sub-html=".lightgallery_caption" data-poster="{{ media.thumbnail|default('') }}" data-video='{"source": [{"src":"{{ media.url }}","type":"{{ media.mime_type }}"}], "attributes": {"preload": false, "playsinline": true, "controls": true}}' title="{{ media.title|default('') }}">
											{% if media.thumbnail %}
												<img loading="lazy" src="{{ media.thumbnail }}"/>
											{% endif %}
											<div class="lightgallery_caption">
												<h4>{{ media.title|default('') }}</h4>
												{% if media.alt %}
													<p>{{ media.alt }}</p>
												{% endif %}
												{% if media.description %}
													<p>{{ media.description }}</p>
												{% endif %}
											</div>
										</a>
									{% endif %}
								{% endfor %}
							</div>

							{# Caption (si présente) #}
							{% if options.captions and (album.author or album.description) %}
								<div class="album-caption">
									{% if album.author %}
										<p class="album-author">{{ album.author }}</p>
									{% endif %}
									{% if album.description %}
										<div class="album-description">
											{{ album.description|raw }}
										</div>
									{% endif %}
								</div>
							{% endif %}

						</div>
					{% endfor %}
				{% endif %}

				{# ---- SOUS-GROUPES (RÉCURSIF) ---- #}
				{% if has_subgroups %}
					{% for subgroup in group.subgroups %}
						{{ _self.render_group_recursive(subgroup, options, group_id, settings, level + 1) }}
					{% endfor %}
				{% endif %}

			</div>
		{% endif %}

	</div>

{% endmacro %}


{# ================= TEMPLATE PRINCIPAL ===================== #}

{% import _self as macros %}

{% set classes = [
  'album-gallery-view',
  'view',
  'view-album-isotope'
] %}

<div{{attributes.addClass(classes)}}
	id="album-gallery-{{ random() }}">

	{# --- CONTENEUR ISOTOPE RACINE ---- #}
	{% set root_id = 'isotope-root-' ~ random() %}
	<div class="isotope-container isotope-root" id="{{ root_id }}" data-level="root">

		{% if groups|length > 0 %}
			{% for group in groups %}
				{{ macros.render_group_recursive(group, options, root_id, settings, 0) }}
			{% endfor %}
		{% else %}
			<p class="no-results">Aucun album trouvé.</p>
		{% endif %}

	</div>

</div>
