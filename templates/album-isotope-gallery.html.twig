{#
  Template récursif pour afficher albums + sous-groupes,
  avec conteneurs imbriqués compatibles Isotope + LightGallery.
#}
{{ dump()}}
{% macro render_group_recursive(group, options) %}

	{# ---- TITRE DU GROUPE --------------------------------------------------------------- #}
	{% if group.title %}
		<h2 class="isotope-group-title level-{{ group.level }}">
			{{ group.title }}
		</h2>
	{% endif %}

	{# ---- CONTENEUR ISOTOPE DE CE GROUPE ------------------------------------------------ #}
	<div
		class="isotope-group level-{{ group.level }}" id="isotope-group-{{ group.title|striptags|trim|clean_class }}-{{ group.level }}" data-isotope-level="{{ group.level }}">

		{# ---- 1) SOUS-GROUPES -------------------------------------------------------------- #}
		{% if group.subgroups is defined and group.subgroups|length > 0 %}
			{% for subgroup in group.subgroups %}
				{{ _self.render_group_recursive(subgroup, options) }}
			{% endfor %}
		{% endif %}

		{# ---- 2) ALBUMS DU GROUPE ---------------------------------------------------------- #}
		{% if group.albums is defined and group.albums|length > 0 %}
			{% for album in group.albums %}

				<div
					class="album-border album-block">

					{# --- ALBUM COVER (CLICK → LIGHTGALLERY) -------------------------------------- #}
					<a href="#" class="album-cover" data-album-id="album-item-{{ album.id }}" data-once="lg-album">
						<span class="album-cover-title-top">{{ album.title }}</span>
						{% if album.image_url %}
							<img src="{{ album.image_url }}" class="album-cover-img" alt="{{ album.title }}" loading="lazy">
						{% endif %}
					</a>

					{# --- LIGHTGALLERY HIDDEN CONTAINER ------------------------------------------- #}
					<div id="album-item-{{ album.id }}" class="lightgallery-album" style="display:none;">

						{% for media in album.medias %}
							{% if media.mime_type starts with 'image/' %}
								<a href="{{ media.url }}" class="lightgallery__item" data-sub-html=".lightgallery_caption">
									<img loading="lazy" src="{{ media.thumbnail }}">
									<div class="lightgallery_caption">
										<h4>{{ media.title|default('') }}</h4>
										{% if media.alt %}
											<p>{{ media.alt }}</p>
										{% endif %}
										{% if media.description %}
											<p>{{ media.description }}</p>
										{% endif %}
									</div>
								</a>
							{% elseif media.mime_type starts with 'video/' %}
								<a class="lightgallery__item" data-sub-html=".lightgallery_caption" data-poster="{{ media.thumbnail|default('') }}" data-video='{"source": [{"src":"{{ media.url }}","type":"{{ media.mime_type }}"}], "attributes": {"preload": false, "playsinline": true, "controls": true}}' "
																																	                title=" {{ media.title|default('') }} ">
									{% if media.thumbnail %}
										<img loading="lazy" class="img-responsive" src="{{ media.thumbnail|default('') }}"/>
									{% endif %}
									<div class="lightgallery_caption">
										<h4>{{ media.title|default('') }}</h4>
										{% if media.alt %}
											<p>{{ media.alt }}</p>
										{% endif %}
										{% if media.description %}
											<p>{{ media.description }}</p>
										{% endif %}
									</div>
								</a>
							{% endif %}
						{% endfor %}

					</div>

					{# --- INFOS SUPPLÉMENTAIRES --------------------------------------------------- #}
					{% if options.captions %}
						<div class="album-caption">
							{% if album.author %}
								<p class="album-author">{{ album.author }}</p>
							{% endif %}
							{% if album.description %}
								<p class="album-description">{{ album.description }}</p>
							{% endif %}
						</div>
					{% endif %}

					<div class="album-media-count">
						{{ album.medias|length }}
						media
					</div>

				</div>

			{% endfor %}
		{% endif %}

	</div>

{% endmacro %}


{# ================= TEMPLATE PRINCIPAL ===================== #}

{% import _self as macros %}

<div{{attributes.addClass(['album-isotope-wrapper'])}}>

	{% if groups|length > 0 %}
		{% for group in groups %}
			{{ macros.render_group_recursive(group, options) }}
		{% endfor %}
	{% else %}
		<p>No results.</p>
	{% endif %}

</div>
